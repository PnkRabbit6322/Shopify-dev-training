{{ 'bundle.css' | asset_url | stylesheet_tag }}
{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-modal-video.css' | asset_url | stylesheet_tag }}
{{ 'component-deferred-media.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top_mobile }}px;
    padding-bottom: {{ section.settings.padding_bottom_mobile }}px;
  }

  .card-wrapper.product-card-wrapper {
    height: 100%;
  }

  .bundle {
    display: grid;
    max-width: 75%;
  }

  .card-wrapper.product-card-wrapper {
    height: fit-content;
  }

  @media screen and (min-width: 768px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top_desktop }}px;
      padding-bottom: {{ section.settings.padding_bottom_desktop }}px;
    }

    .bundle {
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: {{ section.settings.block_spacing_desktop }}px;
    }
  }

  @media screen and (max-width: 767px) {
    .bundle {
      gap: {{ section.settings.block_spacing_mobile }}px;
    }

    .bundle-product-containter {
      align-items: center;
    }

    .bundle--mobile {
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
  }

  div.bundle--product-{{ forloop.index }} {
    grid-column: 1 ;
    grid-row: 1 ;
  }
{%- endstyle -%}

{{ 'bundle-add.js' | asset_url | script_tag }}

<div class="color-{{ section.settings.color_scheme }} gradient isolate">
  <div
    x-data="{ mobile: false }"
    @resize.window="
      width = window.innerWidth > 0 ? window.innerWidth : screen.width;
      if (width <= 749) {
        mobile = true;
      } else {
        mobile = false;
      }
    "
  >
    <div
      class="page-width section-{{ section.id }}-padding px-0"
      :class="mobile ? '{%- if section.settings.fullwidth_mobile -%} w-screen {%- endif -%}' : '{%- if section.settings.fullwidth_desktop -%} w-screen {%- endif -%}'"
    >
      {%- if section.settings.heading != blank -%}
        <h2
          class="bundle-wrapper-title inline-text {{ section.settings.heading_tag }}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
          style="font-size: {{ section.settings.heading_size }}%"
        >
          {{-
            section.settings.heading
            | replace: '[', '<span class="relative inline-block" style="font-weight: bold;">'
            | replace: ']', '</span>'
          -}}
        </h2>
      {%- endif -%}
      {%- if section.settings.subheading_text != blank -%}
        <p class="bundle-wrapper-title inline-text {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}">
          {{- section.settings.subheading_text -}}
        </p>
      {%- endif -%}

      <div
        x-data="
          {
            bundle_items: [],
            bundle_item_ids: [],

            addToBundle(item) {
              if (!{{ section.settings.allow_multiple_products }} || !this.bundle_item_ids.includes(item.variants[0].id)) {
                this.bundle_items.push(item);
                this.bundle_item_ids.push(item.variants[0].id);
              }
            },

            removeFromBundle(index) {
              this.bundle_items.splice(index, 1);
              this.bundle_item_ids.splice(index, 1);
            }
          }
        "
        class="bundle-product-containter flex flex-col gap-2 md:flex-row"
      >
        <div class="bundle{% if section.settings.mobile_layout == 'bundle' %} bundle--mobile{% endif %} w-full h-full flex-grow-8">
          {%- if section.settings.product_list != blank -%}
            {%- for product in section.settings.product_list limit: section.settings.product_shown -%}
              <div
                class="bundle__item bundle__item--product-{{ forloop.index }} {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                {{ block.shopify_attributes }}
                {% if settings.animations_reveal_on_scroll %}
                  data-cascade
                  style="--animation-order: {{ forloop.index }};"
                {% endif %}
              >
                {% assign skip_card_product_styles = false %}
                {%- assign placeholder_image = 'product-apparel-' | append: placeholder_image_index -%}
                {% render 'card-product',
                  card_product: product,
                  media_aspect_ratio: 'adapt',
                  extend_height: true,
                  placeholder_image: placeholder_image,
                  skip_styles: skip_card_product_styles,
                  media_aspect_ratio: 'portrait',
                  bundle: true,
                  section_col_nums_desktop: 1,
                  section_col_nums_mobile: 1,
                  product_size_col: 1
                %}
              </div>
            {%- endfor -%}
          {%- elsif section.settings.collection != blank -%}
            {%- for product in section.settings.collection.products limit: section.settings.product_shown -%}
              <div
                class="bundle__item bundle__item--product-{{ forloop.index }} {% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                {{ block.shopify_attributes }}
                {% if settings.animations_reveal_on_scroll %}
                  data-cascade
                  style="--animation-order: {{ forloop.index }};"
                {% endif %}
              >
                {% render 'card-product',
                  card_product: product,
                  media_aspect_ratio: 'adapt',
                  extend_height: true,
                  placeholder_image: placeholder_image,
                  skip_styles: skip_card_product_styles,
                  media_aspect_ratio: 'portrait',
                  bundle: true,
                  section_col_nums_desktop: 1,
                  section_col_nums_mobile: 1,
                  product_size_col: 1
                %}
              </div>
            {%- endfor -%}
          {%- endif -%}
        </div>
        <div
          class="sticky bottom-0 md:top-0 border-solid border-2 bg-white h-fit border-[{{ section.settings.line_border_color_light }}]"
          {{ block.shopify_attributes }}
          {% if settings.animations_reveal_on_scroll %}
            data-cascade
          {% endif %}
        >
          <div class="p-8">
            {%- if section.settings.summary_heading != blank -%}
              <h2
                class="m-0 bundle-summary-heading inline-text"
              >
                {{- section.settings.summary_heading -}}
              </h2>
            {%- endif -%}
            {%- if section.settings.summary_text != blank -%}
              <p class="mt-2 bundle-summary-text inline-text">
                {{- section.settings.summary_text -}}
              </p>
            {%- endif -%}
            <div class="bundle_summary_item_containter">
              <template x-for="(item, index) in bundle_items">
                <div
                  id="bundle-summary-product-{{ item.id }}"
                  class="cart-item flex flex-row flex-shrink-0 relative py-1.5 gap-2.5"
                >
                  <div class="w-[70px] h-[70px] relative">
                    <img :src="item.featured_image" alt="" loading="lazy">
                    <div
                      class="bundler-button-remove cursor-pointer absolute rtl:-left-1.5 rtl:right-auto -top-1.5 pl-1 pr-1 pt-1 pb-1 -right-1.5 text-black border border-black bg-white rounded-full"
                      @click="removeFromBundle(index)"
                    >
                      <span class="w-2 h-2 block">
                        <svg
                          width="100%"
                          height="100%"
                          viewBox="0 0 10 10"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path d="M0.757812 8.75781L4.75782 4.75783M4.75782 4.75783L8.7578 0.757812M4.75782 4.75783L0.757812 0.757812M4.75782 4.75783L8.7578 8.75781" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                      </span>
                    </div>
                  </div>
                  <div>
                    {%- if settings.show_vendor -%}
                      <p class="caption-with-letter-spacing light" x-text="item.vendor"></p>
                    {%- endif -%}
                    <h3 class="cart-notification-product__name h4" x-text="item.title"></h3>
                    <dl>
                      <div x-show="item.has_only_default_variant">
                        <template x-for="option in item.options_with_values">
                          <div class="product-option">
                            <dt>{{ option.name }}:</dt>
                            <dd>{{ option.value }}</dd>
                          </div>
                        </template>
                      </div>
                    </dl>
                  </div>
                </div>
              </template>
              <div x-show="bundle_items.length">
                <button
                  id="bundle-submit"
                  type="button"
                  name="add"
                  @click="addBundleToCart(bundle_item_ids)"
                  class="quick-add__submit button button--full-width button--secondary"
                  aria-haspopup="dialog"
                  aria-live="polite"
                  data-sold-out-message="true"
                >
                  <span>
                    {{ 'ADD TO CART' }}
                  </span>
                  {%- if horizontal_quick_add -%}
                    <span class="icon-wrap">
                      {{- 'icon-plus.svg' | inline_asset_content -}}
                    </span>
                  {%- endif -%}
                  {%- render 'loading-spinner' -%}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Product bundle",
  "tag": "section",
  "class": "section",
  "enabled_on": {
    "templates": ["collection", "product"]
  },
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "t:sections.collage.settings.heading.label",
      "info": "Wrap your text between [] to add heading highlights. E.g: Adding [marker] will underline [highlight] text.",
      "default": "Product bundles"
    },
    {
      "type": "select",
      "id": "heading_marker",
      "label": "Marker",
      "options": [
        {
          "value": "underline",
          "label": "Underline"
        },
        {
          "value": "font_highlight",
          "label": "Font Highlight"
        }
      ],
      "default": "underline"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Heading size",
      "min": 50,
      "max": 200,
      "unit": "%",
      "step": 10,
      "default": 100
    },
    {
      "type": "select",
      "id": "heading_tag",
      "label": "Heading tag",
      "options": [
        {
          "label": "H1",
          "value": "h1"
        },
        {
          "label": "H2",
          "value": "h2"
        },
        {
          "label": "H3",
          "value": "h3"
        },
        {
          "label": "H4",
          "value": "h4"
        },
        {
          "label": "H5",
          "value": "h5"
        },
        {
          "label": "H6",
          "value": "h6"
        },
        {
          "label": "p",
          "value": "p"
        }
      ],
      "default": "h2"
    },
    {
      "type": "text",
      "id": "subheading_text",
      "label": "text",
      "default": "Create a bundle and save up to 30%!"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "options": [
        {
          "label": "Left",
          "value": "left"
        },
        {
          "label": "Center",
          "value": "center"
        },
        {
          "label": "Right",
          "value": "right"
        }
      ],
      "default": "center"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "'Add to bundle' button label",
      "default": "ADD TO BUNDLE"
    },
    {
      "type": "header",
      "content": "Bundles"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Select collection"
    },
    {
      "type": "range",
      "id": "product_shown",
      "label": "Maximum number of products shown",
      "info": "Only applies to collection select.",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 3
    },
    {
      "type": "product_list",
      "id": "product_list",
      "label": "Select products",
      "info": "Products selected here will override the collection selected above (if exist). Select up to 12 products.",
      "limit": 12
    },
    {
      "type": "checkbox",
      "id": "allow_multiple_products",
      "label": "Each product can be added to bundle once",
      "default": true,
      "info": "If products have variants, each variants can only be added once."
    },
    {
      "type": "range",
      "id": "min_product_to_add",
      "label": "Minimum items in bundle to get discounts",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 3
    },
    {
      "type": "select",
      "id": "discount_type",
      "label": "Discount type",
      "options": [
        {
          "label": "Percentage",
          "value": "percentage"
        },
        {
          "label": "Fixed amount",
          "value": "fixed"
        }
      ],
      "info": "Select the discount type of your preferred discount rule in Admin > Discounts to show the discount price in bundle details.",
      "default": "percentage"
    },
    {
      "type": "text",
      "id": "discount_value",
      "label": "Discount value",
      "info": "Fill in the exact discount percentage or amount of your preferred discount rule in Admin > Discounts. If the value here is different from discount values with selected type in all existing discount rules on the store, the correct discount value cannot be shown in bundle details, but can still be applied in cart and checkout, which might cause customers' confusion."
    },
    {
      "type": "checkbox",
      "id": "discount_bundle_once",
      "label": "Only apply discount once per order",
      "default": false,
      "info": "Setup the same as the 'Only apply discount once per order' setting in the preferred discount rule in admin. If disabled, discount amount will be taken off each eligible item in an order."
    },
    {
      "type": "header",
      "content": "Bundle summary"
    },
    {
      "type": "select",
      "id": "summary_position",
      "label": "Desktop summary position",
      "options": [
        {
          "label": "Left",
          "value": "left"
        },
        {
          "label": "Right",
          "value": "right"
        }
      ],
      "default": "right"
    },
    {
      "type": "text",
      "id": "summary_heading",
      "label": "Bundle heading",
      "default": "Bundle Contents"
    },
    {
      "type": "text",
      "id": "summary_text",
      "label": "Bundle text",
      "default": "Add at least 3 items to get 33% Off"
    },
    {
      "type": "color",
      "id": "bg_color_light",
      "label": "Background color (light)"
    },
    {
      "type": "color",
      "id": "title_color_light",
      "label": "Title color (light)"
    },
    {
      "type": "color",
      "id": "text_color_light",
      "label": "Text color (light)"
    },
    {
      "type": "color",
      "id": "button_color_light",
      "label": "Primary button (light)"
    },
    {
      "type": "color",
      "id": "button_text_color_light",
      "label": "Primary button text (light)"
    },
    {
      "type": "color",
      "id": "button_hover_color_light",
      "label": "Primary button hover (light)"
    },
    {
      "type": "color",
      "id": "button_text_hover_color_light",
      "label": "Primary button hover text (light)"
    },
    {
      "type": "color",
      "id": "line_border_color_light",
      "label": "Line and border (light)"
    },
    {
      "type": "color",
      "id": "bg_color_dark",
      "label": "Background color (dark)"
    },
    {
      "type": "color",
      "id": "title_color_dark",
      "label": "Title color (dark)"
    },
    {
      "type": "color",
      "id": "text_color_dark",
      "label": "Text color (dark)"
    },
    {
      "type": "color",
      "id": "button_color_dark",
      "label": "Primary button (dark)"
    },
    {
      "type": "color",
      "id": "button_text_color_dark",
      "label": "Primary button text (dark)"
    },
    {
      "type": "color",
      "id": "button_hover_color_dark",
      "label": "Primary button hover (dark)"
    },
    {
      "type": "color",
      "id": "button_text_hover_color_dark",
      "label": "Primary button hover text (dark)"
    },
    {
      "type": "color",
      "id": "line_border_color_dark",
      "label": "Line and border (dark)"
    },
    {
      "type": "header",
      "content": "Desktop layout"
    },
    {
      "type": "range",
      "id": "block_spacing_desktop",
      "label": "Block spacing",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 28
    },
    {
      "type": "checkbox",
      "id": "fullwidth_desktop",
      "label": "Make section full width",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "divider_desktop",
      "label": "Show section divider",
      "default": false
    },
    {
      "type": "range",
      "id": "padding_top_desktop",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 28
    },
    {
      "type": "range",
      "id": "padding_bottom_desktop",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 28
    },
    {
      "type": "header",
      "content": "Mobile layout"
    },
    {
      "type": "radio",
      "id": "column_amount_mobile",
      "label": "Number of columns",
      "options": [
        {
          "label": "1",
          "value": "1"
        },
        {
          "label": "2",
          "value": "2"
        }
      ],
      "default": "2"
    },
    {
      "type": "range",
      "id": "block_spacing_mobile",
      "label": "Block spacing",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "fullwidth_mobile",
      "label": "Make section full width",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "divider_mobile",
      "label": "Show section divider",
      "default": false
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Top padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 28
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Bottom padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 28
    }
  ],
  "presets": [
    {
      "name": "Product bundle"
    }
  ]
}
{% endschema %}
